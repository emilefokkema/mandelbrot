
<html>
<body style="margin:0px;padding:0px"></body>
<script>
(function(body){
	var Complex = function(x,y){
		this.x = x;
		this.y = y;
	};
	Complex.prototype.plus = function(c){
		return new Complex(this.x + c.x, this.y + c.y);
	};
	Complex.prototype.square = function(){
		return new Complex(Math.pow(this.x, 2) - Math.pow(this.y, 2), 2* this.x * this.y);
	};
	Complex.prototype.modSq = function(){
		return Math.pow(this.x, 2) + Math.pow(this.y, 2);
	};
	var escapeStep = function(maxIt,x,y){
		var z = new Complex(0,0), c = new Complex(x,y), step = 0;
		while((z = z.square().plus(c)).modSq() < 4 && step++ < maxIt){

		}
		var modsq = z.modSq();
		
		return {modsq:modsq, step:step};
	};
	var makeIterator = function(arr){
		if(!arr || arr.length == 0){
			return function(){};
		}else{
			var i = 0;
			return function(){
				if(i < arr.length){
					return arr[i++];
				}
			};
		}
		
	};
	var makeSpiralIterator = (function(){
		var repeater = function(arr){
			var i = 0;
			return {
				next:function(){
					if(i >= arr.length){
						i = 0;
					}
					return arr[i++];
				}
			};
		};
		var direction = function(){
			return repeater([
				{i:1,j:0},
				{i:0,j:1},
				{i:-1,j:0},
				{i:0,j:-1}
			]);
		};
		var rectangle = function(imin, imax, jmin, jmax){
			return {
				imin:imin,
				imax:imax,
				jmin:jmin,
				jmax:jmax,
				contains:function(index){
					var i = index.i, j = index.j;
					return imin <= i && i <= imax && jmin <= j && j <= jmax;
				},
				join:function(r){
					return rectangle(Math.min(imin, r.imin), Math.max(imax, r.imax), Math.min(jmin, r.jmin), Math.max(jmax, r.jmax));
				}
			};
		};
		var spiralingIndex = function(iStart, jStart){
			var currentRectangle = rectangle(iStart, iStart, jStart, jStart),
				currentIndex = {i:iStart,j:jStart},
				directionGiver = direction(); 
				currentDirection = directionGiver.next();

			return {
				next:function(){
					var result = currentIndex;
					currentIndex = {i:currentIndex.i + currentDirection.i, j: currentIndex.j + currentDirection.j};
					if(!currentRectangle.contains(currentIndex)){
						currentRectangle = currentRectangle.join(rectangle(currentIndex.i, currentIndex.i, currentIndex.j, currentIndex.j));
						currentDirection = directionGiver.next();
					}
					return result;
				}
			};
		};
		
		
		
		return function(arr, iStart, jStart){
			if(!arr || arr.length == 0){
				return function(){};
			}else{
				var index,
					count = 0,
					maxCount = arr.length * arr[0].length;
					indexRectangle = rectangle(0, arr.length - 1, 0, arr[0].length - 1),
					spiral = spiralingIndex(iStart, jStart),
					going = true;

				var toReturn = function(){
					if(count >= maxCount){
						console.log("klaar met spiraal");
						return;
					}
					var whileCounter = 0;
					while(!indexRectangle.contains((index = spiral.next())) && going && whileCounter++<4000){
						console.log("overslaan", count, maxCount);
						if(whileCounter == 4000){
							console.log("nee");
						}

					}
					count ++;
					return arr[index.i][index.j];
				};
				return toReturn;
			}
		};
	})();
		
	var doSequentially = function(nextToDo, batchSize, whetherToContinue){
		var next;
		var todo = function(){
			if(whetherToContinue()){
				var batchCounter = 0;
				while(batchCounter++ <= batchSize && (next = nextToDo())){
					next();
				}
				if(whetherToContinue() && next){
					setTimeout(todo,1);
				}
			}
			
		};
		todo();
	};
	
	var field = (function(){
		var canvas = document.createElement('canvas');
		var squares,width = body.offsetWidth, height = body.offsetHeight, stopDrawing = function(){};
		canvas.setAttribute('width', width);
		canvas.setAttribute('height', height);
		body.appendChild(canvas);
		var context = canvas.getContext('2d');
		var setBoundaries = function(orX, orY, Xwidth){
			stopDrawing();
			coordinates.set(orX, orY, Xwidth);
			stopDrawing = draw();
		};
		var coordinates = (function(w,h){
			var minx,maxx,miny,maxy;
			var getFromScreenXY = function(x,y){
				var cx = minx + (x / w) * (maxx - minx);
				var cy = maxy - (y / h) * (maxy - miny);
				return {x:cx,y:cy};
			};
			var set = function(orX, orY, Xwidth){
				minx = orX - Xwidth / 2;
				maxx = orX + Xwidth / 2;
				var Ywidth = Xwidth * (h / w);
				miny = orY - Ywidth / 2;
				maxy = orY + Ywidth / 2;
			};
			var getWidth = function(){return maxx - minx;};
			return {
				set:set,
				getFromScreenXY:getFromScreenXY,
				getWidth:getWidth
			};
		})(width, height);
		
		var draw = function(){
			var drawing = true;
			var squaresInRow = squares.reduce(function(a,b){return a.concat(b);});
			squaresInRow.map(function(s){s.draw();});
			var functions = squares.map(function(r){return r.map(function(rr){return rr.drawDetailed;});});
			var iterator = makeSpiralIterator(functions, Math.floor(squares.length/2), Math.floor(squares[0].length/2));
			doSequentially(
				iterator,
				30,
				function(){return drawing;}
			);
			return function(){drawing = false;};
		};

		canvas.onclick = function(e){
			var x = e.clientX, y = e.clientY;
			var zoomFactor = Math.min.apply(null, [x, x - width, y, y - height].map(Math.abs)) < 50 ? 2 : 0.5;
			var coords = zoomFactor < 1 ? coordinates.getFromScreenXY(x, y) : coordinates.getFromScreenXY(width/2, height/2);
			setBoundaries(coords.x, coords.y, coordinates.getWidth() * zoomFactor);
		};
		var square = function(x,y,size){
			var coords;
			var draw = function(){
				coords = coordinates.getFromScreenXY(x,y);
				var esc = escapeStep(2000,coords.x,coords.y);
				if(esc.modsq < 4){
					context.fillStyle = '#000';
					context.fillRect(x, y, size, size);
				}else{
					var normalizedStep = esc.step + 1 - Math.log(Math.log(Math.sqrt(esc.modsq))) / Math.log(2);
					context.fillStyle = 'hsl('+normalizedStep*2+',50%,50%)';
					context.fillRect(x, y, size, size);
				}
			};
			var drawDetailed = function(){
				var smallSquares = getSquares(x, x+size, y, y+size, 1);
				smallSquares.reduce(function(a,b){return a.concat(b);}).map(function(s){s.draw();});
			};
			return {
				draw:draw,
				drawDetailed:drawDetailed
			};
		};
		var getSquares = function(minx, maxx, miny, maxy, size){
			var rresult, result = [];
			for(var x = minx; x < maxx; x+=size){
				rresult = [];
				for(var y = miny;y < maxy; y+=size){
					rresult.push(square(x, y, size));
				}
				result.push(rresult);
			}
			return result;
		};
		squares = getSquares(0, width, 0, height, 20);
		setBoundaries(0,0,4);
		
	})();
})(document.body);
</script>
</html>