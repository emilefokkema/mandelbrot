<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
</head>
<body style="margin:0px;padding:0px"></body>
<div id="cross" style="width:100%;height:20px;background-image:url(&quot;data:image/svg+xml;utf8,<svg width=\&quot;20\&quot; height=\&quot;20\&quot; xmlns=\&quot;http://www.w3.org/2000/svg\&quot;><path d=\&quot;M15.65685424949238 18.485281374238568 L 18.48528137423857 15.65685424949238 L 12.828427124746192 10 L 18.48528137423857 4.34314575050762 L 15.65685424949238 1.5147186257614305 L 10.000000000000002 7.17157287525381 L 4.343145750507619 1.5147186257614305 L 1.5147186257614287 4.34314575050762 L 7.171572875253809 10 L 1.5147186257614287 15.65685424949238 L 4.343145750507619 18.485281374238568 L 9.999999999999998 12.82842712474619 L 15.65685424949238 18.485281374238568 Z\&quot; fill=\&quot;black\&quot;></path></svg>&quot;);background-repeat:no-repeat"></div>
<script src="../sudoku/makeNode.js"></script>
<script>
(function(body){
	
	
	var escapeStep = function(maxIt, x, y){
		var zrn, zin, zr = 0, zi = 0, cr = x, ci = y, step = 0, modsq = 0;
		while(modsq < 4 && step++ < maxIt){
			zrn = zr * zr - zi * zi + cr;
			zin = 2 * zr * zi + ci;
			zr = zrn;
			zi = zin;
			modsq = zr * zr + zi * zi;
		}

		return {modsq:modsq, step:step};
	};
	var makeIterator = function(arr){
		if(!arr || arr.length == 0){
			return function(){};
		}else{
			var i = 0;
			return function(){
				if(i < arr.length){
					return arr[i++];
				}
			};
		}
		
	};
	var makeSpiralIterator = (function(){
		var repeater = function(arr){
			var i = 0;
			return {
				next:function(){
					if(i >= arr.length){
						i = 0;
					}
					return arr[i++];
				}
			};
		};
		var direction = function(){
			return repeater([
				{i:1,j:0},
				{i:0,j:1},
				{i:-1,j:0},
				{i:0,j:-1}
			]);
		};
		var rectangle = function(imin, imax, jmin, jmax){
			return {
				imin:imin,
				imax:imax,
				jmin:jmin,
				jmax:jmax,
				contains:function(index){
					var i = index.i, j = index.j;
					return imin <= i && i <= imax && jmin <= j && j <= jmax;
				},
				join:function(r){
					return rectangle(Math.min(imin, r.imin), Math.max(imax, r.imax), Math.min(jmin, r.jmin), Math.max(jmax, r.jmax));
				}
			};
		};
		var spiralingIndex = function(iStart, jStart){
			var currentRectangle = rectangle(iStart, iStart, jStart, jStart),
				currentIndex = {i:iStart,j:jStart},
				directionGiver = direction(); 
				currentDirection = directionGiver.next();

			return {
				next:function(){
					var result = currentIndex;
					currentIndex = {i:currentIndex.i + currentDirection.i, j: currentIndex.j + currentDirection.j};
					if(!currentRectangle.contains(currentIndex)){
						currentRectangle = currentRectangle.join(rectangle(currentIndex.i, currentIndex.i, currentIndex.j, currentIndex.j));
						currentDirection = directionGiver.next();
					}
					return result;
				}
			};
		};
		
		
		
		return function(arr, iStart, jStart){
			if(!arr || arr.length == 0){
				return function(){};
			}else{
				var index,
					count = 0,
					maxCount = arr.length * arr[0].length;
					indexRectangle = rectangle(0, arr.length - 1, 0, arr[0].length - 1),
					spiral = spiralingIndex(iStart, jStart),
					going = true;

				var toReturn = function(){
					if(count >= maxCount){
						console.log("klaar met spiraal");
						return;
					}
					while(!indexRectangle.contains((index = spiral.next())) && going){
						

					}
					count ++;
					return arr[index.i][index.j];
				};
				return toReturn;
			}
		};
	})();
		
	var doSequentially = function(nextToDo, batchSize, whetherToContinue, doneCallback){
		var next;
		var todo = function(){
			if(whetherToContinue()){
				var batchCounter = 0;
				while(whetherToContinue() && batchCounter++ <= batchSize && (next = nextToDo())){
					next();
				}
				if(!next && doneCallback){
					doneCallback();
				}
				if(whetherToContinue() && next){
					setTimeout(todo,1);
				}
			}
			
		};
		todo();
		return todo;
	};

	var storage = (function(){
		var read = function(){
			var match = window.location.hash.match(/^#(-?\d+(?:\.\d+)?(?:e-?\d+)?),(-?\d+(?:\.\d+)?(?:e-?\d+)?),(\d+(?:\.\d+)?(?:e-?\d+)?)$/);
			if(match){
				return {
					orX : parseFloat(match[1]),
					orY : parseFloat(match[2]),
					Xwidth : parseFloat(match[3])
				};
			}else{
				return {
					orX: 0,
					orY :0,
					Xwidth : 4
				};
			}
		};
		var write = function(orX, orY, Xwidth){
			window.location.hash = "#" + orX + "," + orY + "," + Xwidth;
		};
		return {
			read:read,
			write:write
		};
	})();

	var colorSchemes = [
		{
			lightness: function(normalizedStep){
				return 50 * (1 + Math.sin(normalizedStep / 20));
			},
			hue: function(normalizedStep){
				return normalizedStep*2;
			}
		},
		{
			lightness: function(normalizedStep){
				return 50 * (1 + Math.sin(normalizedStep / 20));
			},
			hue: function(normalizedStep){
				return 2*normalizedStep - Math.pow(normalizedStep, 2) / 100;
			}
		},
		{
			lightness:function(n){
				return 50 * (1 + 0.75 * Math.sin(n / 10));
			},
			hue: function(n){
				return 120 * Math.sin(n / 20);
			}
		}
	];

	var field = (function(){
		var canvas = document.createElement('canvas');
		var squares,width = body.offsetWidth, height = body.offsetHeight, drawing = {stop:function(){},resume:function(){}};
		canvas.setAttribute('width', width);
		canvas.setAttribute('height', height);
		body.appendChild(canvas);
		var context = canvas.getContext('2d');
		var setBoundaries = function(orX, orY, Xwidth){
			drawing.stop();
			coordinates.set(orX, orY, Xwidth);
			storage.write(orX, orY, Xwidth);
			drawing = draw();
		};
		var redraw = function(){
			drawing.stop();
			drawing = draw();
		};
		var coordinates = (function(w,h){
			var minx,maxx,miny,maxy;
			var getFromScreenXY = function(x,y){
				var cx = minx + (x / w) * (maxx - minx);
				var cy = maxy - (y / h) * (maxy - miny);
				return {x:cx,y:cy};
			};
			var set = function(orX, orY, Xwidth){
				minx = orX - Xwidth / 2;
				maxx = orX + Xwidth / 2;
				var Ywidth = Xwidth * (h / w);
				miny = orY - Ywidth / 2;
				maxy = orY + Ywidth / 2;
			};
			var getWidth = function(){return maxx - minx;};
			return {
				set:set,
				getFromScreenXY:getFromScreenXY,
				getWidth:getWidth
			};
		})(width, height);
		
		var draw = function(){
			var drawing = true;
			var whetherToContinue = function(){return drawing;};
			var squaresDraw = squares.map(function(r){return r.map(function(rr){return rr.draw;});});
			var resume;
			resume = doSequentially(
				makeSpiralIterator(squaresDraw, Math.floor(squares.length/2), Math.floor(squares[0].length/2)),
				200,
				whetherToContinue,
				function(){
					var functions = squares.map(function(r){return r.map(function(rr){return rr.drawDetailed;});});
					var iterator = makeSpiralIterator(functions, Math.floor(squares.length/2), Math.floor(squares[0].length/2));
					resume = doSequentially(
						iterator,
						30,
						whetherToContinue
					);
				}
			);
			return {
				stop: function(){drawing = false;},
				resume: function(){drawing = true;resume();}
			};
		};
		var isNearEdge = function(x,y){
			return Math.min.apply(null, [x, x - width, y, y - height].map(Math.abs)) < 50;
		};
		var clickNormal = function(e){
			var x = e.clientX, y = e.clientY;
			var zoomFactor = isNearEdge(x,y) ? 2 : 0.5;
			var coords = zoomFactor < 1 ? coordinates.getFromScreenXY(x, y) : coordinates.getFromScreenXY(width/2, height/2);
			setBoundaries(coords.x, coords.y, coordinates.getWidth() * zoomFactor);
		};
		var clickOther = function(){
			drawing.stop();
			contextMenu.appear(function(chosenToDo){
				setTimeout(function(){
					drawing.resume();
					(chosenToDo || function(){})();
				},300)
			});
		};
		canvas.addEventListener('click', clickNormal);
		canvas.addEventListener('contextmenu',function(e){
			if(isNearEdge(e.clientX, e.clientY)){
				e.preventDefault();
				clickOther();
			}
		});
		var colorScheme = colorSchemes[0];
		var square = function(x,y,size){
			var coords;
			var draw = function(){
				coords = coordinates.getFromScreenXY(x,y);
				var esc = escapeStep(4000,coords.x,coords.y);
				if(esc.modsq < 4){
					context.fillStyle = '#000';
					context.fillRect(x, y, size, size);
				}else{
					var normalizedStep = esc.step + 1 - Math.log(Math.log(Math.sqrt(esc.modsq))) * 1.4426950408889634;
					context.fillStyle = 'hsl('+colorScheme.hue(normalizedStep)+',50%,'+colorScheme.lightness(normalizedStep)+'%)';
					context.fillRect(x, y, size, size);
				}
			};
			var drawDetailed = function(){
				var smallSquares = getSquares(x, x+size, y, y+size, 1);
				smallSquares.reduce(function(a,b){return a.concat(b);}).map(function(s){s.draw();});
			};
			return {
				draw:draw,
				drawDetailed:drawDetailed
			};
		};
		var getSquares = function(minx, maxx, miny, maxy, size){
			var rresult, result = [];
			for(var x = minx; x < maxx; x+=size){
				rresult = [];
				for(var y = miny;y < maxy; y+=size){
					rresult.push(square(x, y, size));
				}
				result.push(rresult);
			}
			return result;
		};
		squares = getSquares(0, width, 0, height, 10);
		var whereWeAre = storage.read();
		setBoundaries(whereWeAre.orX, whereWeAre.orY, whereWeAre.Xwidth);
		var setColorScheme = function(s){
			if(s == colorScheme){return;}
			colorScheme = s;
			redraw();
		};
		return {
			setBoundaries: setBoundaries,
			setColorScheme: setColorScheme
		};
	})();
	var contextMenu = (function(){
		var upTop = -body.offsetHeight * 0.9;
		var downTop = body.offsetHeight * 0.05;
		var left = body.offsetWidth * 0.05;
		var onClose = function(){};
		var makeColorSchemePicture = function(scheme){
			var canvas = document.createElement('canvas');
			canvas.width = 300;
			canvas.height = 50;
			var context = canvas.getContext('2d');
			for(var i=0;i<300;i++){
				context.fillStyle = 'hsl('+scheme.hue(i)+',50%,'+scheme.lightness(i)+'%)';
				context.fillRect(i,0,1,50);
			}
			return canvas;
		};
		return makeNode(
			"<div id='1' style='position:absolute;left:"+left+"px;top:"+upTop+"px;transition-property:top;transition-duration:0.1s;background-color:#eee;width:90%;height:90%'>"+
				"<div id='5' style='position:relative;padding:3px'></div>" +
				"<input id='2' type='button' value='x' />" +
				"<input id='3' type='button' value='reset'/>" +
				"<div id='4'></div>" +
			"</div>",
			function(div, close, reset, schemes, header){
				header.appendChild(document.getElementById('cross'));
				body.appendChild(div);
				var appear = function(){
					div.style.top = downTop + "px";
				};
				var disappear = function(chosenToDo){
					div.style.top = upTop + "px";
					onClose(chosenToDo);
				};
				close.onclick = function(){
					disappear();
				};
				reset.onclick = function(){
					disappear(function(){
						field.setBoundaries(0,0,4);
					});
				};
				var colorSchemeOptions = (function(){
					var select = function(i){
						all.map(function(o,j){
							o.makeActive(i == j);
						});
						disappear(function(){
							field.setColorScheme(colorSchemes[i]);
						});
					};
					var all = colorSchemes.map(function(scheme, i){
						return makeNode(
							"<div id='1'></div>",
							function(div){
								div.appendChild(makeColorSchemePicture(scheme));
								var makeActive = function(bool){
									div.style.backgroundColor = bool ? "#aaa" : "";
								};
								div.onclick = function(){select(i);};
								return {
									node:div,
									makeActive:makeActive
								};
							}
						);
					});
					all.map(function(o){schemes.appendChild(o.node);});
					select(0);
				})();
				
				return {
					appear:function(f){onClose = f;appear();}
				};
			});
	})();
})(document.body);
</script>
</html>