<html>
<head>
	<style>
		body{margin: 0; padding: 0}
		canvas{width: 100%;height:100%;}
	</style>
</head>
<body>
<canvas width="900" height="700" id="canvas"/>
<script type="application/javascript">
	(function(){
		var canvas = document.getElementById("canvas");
		var clientRect = canvas.getBoundingClientRect();
		var width = clientRect.width;
		var height = clientRect.height;
		canvas.setAttribute("width", width);
		canvas.setAttribute("height", height);
		var context = canvas.getContext("2d");
		var workerFn = (function(postMessage, onmessage){
			return function(size){
				var length = 4 * size * size;
				var escapeStep = function(maxIt, x, y){
					var zrn, zin, zr = 0, zi = 0, cr = x, ci = y, step = 0, modsq = 0;
					while(modsq < 4 && step++ < maxIt){
						zrn = zr * zr - zi * zi + cr;
						zin = 2 * zr * zi + ci;
						zr = zrn;
						zi = zin;
						modsq = zr * zr + zi * zi;
					}
					return {modsq:modsq, step:step};
				};
				onmessage = function(m){
					var data = m.data;
					var origX = data.origX;
					var origY = data.origY;
					var scaleX = data.scaleX;
					var scaleY = data.scaleY;
					var array = new Uint8ClampedArray(length);
					var inPreviousRows = 0;
					for(var tileY = 0;tileY < size; tileY++){
						for(var tileX = 0; tileX < size; tileX++){
							var index = inPreviousRows + tileX * 4;
							var realX = origX + tileX * scaleX;
							var realY = origY + tileY * scaleY;
							var st = escapeStep(4000, realX, realY);
							var normalizedStep = st.step + 1 - Math.log(Math.log(Math.sqrt(st.modsq))) * 1.4426950408889634;
							var hue = normalizedStep * 2;
							var lightness = st.modsq < 4 ? 0 : 175 * (1 + Math.sin(normalizedStep / 20));
							array[index] = lightness;
							array[index + 1] = lightness;
							array[index + 2] = lightness;
							array[index + 3] = 255;
						}
						inPreviousRows += size * 4;
					}
					postMessage(array.buffer, [array.buffer]);
					
				};
			};
		})();
		var tileSize = 100;
		var WorkerWrapper = function(){
			var self = this;
			this.onmessage = function(){};
			this.busy = false;
			this.worker = new Worker(URL.createObjectURL(new Blob(['('+workerFn.toString()+')('+tileSize+')'], {type: "application/javascript"})));
			this.worker.onmessage = function(m){
				self.onmessage(m);
				self.busy = false;
			}
		};
		WorkerWrapper.prototype.postMessage = function(message, onResponse){
			this.onmessage = onResponse;
			this.busy = true;
			this.worker.postMessage(message);
		};
		var WorkerPoolJob = function(message, onResponse){
			this.message = message;
			this.onResponse = onResponse;
		};
		var WorkerPool = function(){
			this.workers = Array.apply(null, new Array(12)).map(function(){return new WorkerWrapper();});
			this.jobs = [];
		};
		WorkerPool.prototype.executeNextJob = function(){
			if(!this.jobs.length){
				return;
			}
			var freeWorker = this.workers.find(function(w){return !w.busy;});
			if(!freeWorker){return;}
			var job = this.jobs.pop();
			var self = this;
			freeWorker.postMessage(job.message, function(r){
				job.onResponse(r);
				self.executeNextJob();
			});
		};
		WorkerPool.prototype.createJob = function(message, onResponse){
			var job = new WorkerPoolJob(message, onResponse);
			this.jobs.push(job);
			this.executeNextJob();
			return job;
		};
		var Tile = function(workerPool, x, y){
			this.x = x;
			this.y = y;
			this.workerPool = workerPool;
			// this.worker = new Worker(URL.createObjectURL(new Blob(['('+workerFn.toString()+')('+size+')'], {type: "application/javascript"})));
			// this.worker.onmessage = function(e){
			// 	var buffer = e.data;
			// 	var array = new Uint8ClampedArray(buffer);
			// 	var imageData = new ImageData(array, tileSize);
			// 	context.putImageData(imageData, x, y);
			// };
		};
		Tile.prototype.drawArrayBuffer = function(buffer){
			var array = new Uint8ClampedArray(buffer);
			var imageData = new ImageData(array, tileSize);
			context.putImageData(imageData, this.x, this.y);
		};
		Tile.prototype.draw = function(origX, origY, scaleX, scaleY){
			var self = this;
			var job = this.workerPool.createJob({origX: origX, origY: origY, scaleX: scaleX, scaleY: scaleY}, function(m){
				self.drawArrayBuffer(m.data);
			});
			//this.worker.postMessage({origX: origX, origY: origY, scaleX: scaleX, scaleY: scaleY});
		};
		var workerPool = new WorkerPool();
		var nRows = Math.floor(height / tileSize) + 1;
		var nCols = Math.floor(width / tileSize) + 1;
		var tiles = [];
		for(var i=0;i<nRows;i++){
			var row = [];
			tiles.push(row);
			for(var j=0;j<nCols;j++){
				var tile = new Tile(workerPool, j * tileSize, i * tileSize);
				row.push(tile);
			}
		}
		var centerX = 0;
		var centerY = 0;
		var virtualWidth = 4;
		var draw = function(){
			var scale = virtualWidth / width;
			var virtualHeight = height * scale;
			var left = centerX - virtualWidth / 2;
			var top = centerY + virtualHeight / 2;
			var virtualTileSize = tileSize * scale;
			for(var i=0;i<nRows;i++){
				for(var j=0;j<nCols;j++){
					tiles[i][j].draw(left + j * virtualTileSize, top - i * virtualTileSize, scale, -scale);
				}
			}
		};
		var zoomIn = function(clientX, clientY){
			var scale = virtualWidth / width;
			var virtualHeight = height * scale;
			var virtualX = (centerX - virtualWidth / 2) + clientX * scale;
			var virtualY = (centerY + virtualHeight / 2) - clientY * scale;
			centerX = virtualX;
			centerY = virtualY;
			virtualWidth = virtualWidth / 3;
			draw();
		};
		var zoomOut = function(){
			virtualWidth = virtualWidth * 3;
			draw();
		};
		draw(0, 0, 4);
		canvas.addEventListener("click", function(ev){
			var clientX = ev.clientX;
			var clientY = ev.clientY;
			if(clientX < 40 || width - clientX < 40 || clientY < 40 || height - clientY < 40){
				zoomOut();
			}else{
				zoomIn(clientX, clientY);
			}
		});
	})();
</script>
</body>
</html>