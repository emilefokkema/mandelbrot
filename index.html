<html>
<head>
	<style>
		body{margin: 0; padding: 0}
	</style>
</head>
<body>
<canvas width="900" height="700" id="canvas"/>
<script type="application/javascript">
	(function(){
		var canvas = document.getElementById("canvas");
		var width = canvas.width;
		var height = canvas.height;
		var context = canvas.getContext("2d");
		var workerFn = (function(postMessage, onmessage){
			return function(size){
				var length = 4 * size * size;
				var escapeStep = function(maxIt, x, y){
					var zrn, zin, zr = 0, zi = 0, cr = x, ci = y, step = 0, modsq = 0;
					while(modsq < 4 && step++ < maxIt){
						zrn = zr * zr - zi * zi + cr;
						zin = 2 * zr * zi + ci;
						zr = zrn;
						zi = zin;
						modsq = zr * zr + zi * zi;
					}
					return {modsq:modsq, step:step};
				};
				onmessage = function(m){
					var data = m.data;
					var origX = data.origX;
					var origY = data.origY;
					var scaleX = data.scaleX;
					var scaleY = data.scaleY;
					var array = new Uint8ClampedArray(length);
					var inPreviousRows = 0;
					for(var tileY = 0;tileY < size; tileY++){
						for(var tileX = 0; tileX < size; tileX++){
							var index = inPreviousRows + tileX * 4;
							var realX = origX + tileX * scaleX;
							var realY = origY + tileY * scaleY;
							var st = escapeStep(50, realX, realY);
							var normalizedStep = st.step + 1 - Math.log(Math.log(Math.sqrt(st.modsq))) * 1.4426950408889634;
							array[index] = st.modsq < 4 ? 0 : 10 * normalizedStep;
							//array[index] = 100 + 50 * Math.sin(realX) + 50 * Math.sin(realY);
							array[index + 3] = 255;
						}
						inPreviousRows += size * 4;
					}
					if(array.length === 0){
						debugger;
					}
					postMessage(array.buffer, [array.buffer]);
					
				};
			};
		})();
		var tileSize = 75;
		var Tile = function(x, y, size){
			this.worker = new Worker(URL.createObjectURL(new Blob(['('+workerFn.toString()+')('+size+')'], {type: "application/javascript"})));
			this.worker.onmessage = function(e){
				var buffer = e.data;
				var array = new Uint8ClampedArray(buffer);
				console.log(array);
				var imageData = new ImageData(array, tileSize);
				context.putImageData(imageData, x, y);
			};
		};
		Tile.prototype.draw = function(origX, origY, scaleX, scaleY){
			this.worker.postMessage({origX: origX, origY: origY, scaleX: scaleX, scaleY: scaleY});
		};
		var nRows = Math.floor(height / tileSize) + 1;
		var nCols = Math.floor(width / tileSize) + 1;
		var tiles = [];
		var left = -2;
		var top = 2;
		var virtualWidth = 3;
		var virtualHeight = 3;
		var virtualTileSize = virtualWidth * tileSize / width;
		for(var i=0;i<nRows;i++){
			var row = [];
			tiles.push(row);
			for(var j=0;j<nCols;j++){
				var tile = new Tile(j * tileSize, i * tileSize, tileSize);

				tile.draw(left + j * virtualTileSize, top - i * virtualTileSize, virtualTileSize / tileSize, -virtualTileSize / tileSize);
				row.push(tile);
			}
		}
	})();
</script>
</body>
</html>