<html>
	<head>
		<script type="text/javascript" src="parallel-processor.js"></script>
		<style type="text/css">
			body{padding:0px;margin:0px;}
			canvas{width:100%;height:100%;}
		</style>
	</head>
<body>
	<canvas id="canvas"></canvas>
	<script>
		(function(){
			var canvas = document.getElementById("canvas");
			var rect = canvas.getBoundingClientRect();
			var width = rect.width * devicePixelRatio, height = rect.height * devicePixelRatio;
			canvas.setAttribute("width", width);
			canvas.setAttribute("height", height);
			var context = canvas.getContext("2d");
			var sliceWidth = 10;
			var currentCancellationToken = undefined;
			var coordsMinX = 0;
			var coordsMaxX = 4;
			var coordsMinY = 0;
			var coordsMaxY = 5 * height / width;
			var processor = new ParallelProcessor(10, "(" + (function(){
				var sliceWidth, coordsMinX, coordsMinY, coordsMaxX, coordsMaxY, width, height;
				var getCoordsX = function(x){
					return coordsMinX + (coordsMaxX - coordsMinX) * x / width;
				};
				var getRealY = function(y){
					return Math.floor(height * (coordsMaxY - y) / (coordsMaxY - coordsMinY));
				};
				var getArrayIndexForPoint = function(x, y){
					return 4 * sliceWidth * y + 4 * x;
				};
				var colorPoint = function(x, y, array){
					if(x >= 0 && x < sliceWidth && y >= 0 && y < height){
						var index = getArrayIndexForPoint(x, y);
						array[index + 3] += 10;
					}
				};
				var displayValue = function(value, x, array){
					var realY = getRealY(value);
					colorPoint(x, realY, array);
					colorPoint(x, realY + 1, array);
					colorPoint(x, realY - 1, array);
				};
				var drawPointsForX = function(sliceStart, x, array){
					var coordsX = getCoordsX(sliceStart + x);
					var value = 0.1;
					var counter = 0;
					while(counter < 20000){
						if(counter > 10000){
							displayValue(value, x, array);
						}
						value = coordsX * value * (1 - value);
						counter++;
					}
				};
				process = function(req){
					var array = new Uint8ClampedArray(4 * sliceWidth * height);
					for(var x = 0; x < sliceWidth; x++){
						drawPointsForX(req.x, x, array);
					}
					return array.buffer;
				};
				update = function(_sliceWidth, _coordsMinX, _coordsMinY, _coordsMaxX, _coordsMaxY, _width, _height){
					sliceWidth = _sliceWidth;
					coordsMinX = _coordsMinX;
					coordsMinY = _coordsMinY;
					coordsMaxX = _coordsMaxX;
					coordsMaxY = _coordsMaxY;
					width = _width;
					height = _height;
				};		
			}).toString() + ")()");

			var drawSlice = async function(x, cancellationToken){
				var buffer = await processor.process({x: x}, cancellationToken);
				var array = new Uint8ClampedArray(buffer);
				var imageData = new ImageData(array, sliceWidth);
				context.putImageData(imageData, x, 0);
			};

			var drawAll = async function(){
				if(currentCancellationToken){
					currentCancellationToken.cancel();
				}
				context.clearRect(0, 0, width, height);
				await processor.update(sliceWidth, coordsMinX, coordsMinY, coordsMaxX, coordsMaxY, width, height);
				currentCancellationToken = processor.getCancellationToken();
				var numberOfSlices = Math.ceil(width / sliceWidth);
				for(var i=0;i<numberOfSlices;i++){
					drawSlice(i * sliceWidth, currentCancellationToken);
				}
			};

			drawAll();

			var borderWidth = Math.min(width / 6, height / 6);
			canvas.addEventListener("click", function(e){
				var realX = e.clientX * devicePixelRatio;
				var realY = e.clientY * devicePixelRatio;
				var coordsWidth = coordsMaxX - coordsMinX;
				var coordsHeight = coordsMaxY - coordsMinY;
				if(realX < borderWidth || width - realX < borderWidth || realY < borderWidth || height - realY < borderWidth){
					var xMiddle = (coordsMaxX + coordsMinX) / 2;
					var yMiddle = (coordsMaxY + coordsMinY) / 2;
					coordsMinX = xMiddle - coordsWidth;
					coordsMaxX = xMiddle + coordsWidth;
					coordsMinY = yMiddle - coordsHeight;
					coordsMaxY = yMiddle + coordsHeight;
				}else{
					var coordsX = coordsMinX + coordsWidth * realX / width;
					var coordsY = coordsMaxY - coordsHeight * realY / height;
					coordsMinX = coordsX - coordsWidth / 4;
					coordsMaxX = coordsX + coordsWidth / 4;
					coordsMinY = coordsY - coordsHeight / 4;
					coordsMaxY = coordsY + coordsHeight / 4;
				}
				
				drawAll();
			});
		})();
	</script>
</body>
</html>