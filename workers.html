<html>
	<head>
		<script type="text/javascript" src="parallel-processor.js"></script>
		<style type="text/css">
			body{padding:0px;margin:0px;overflow: hidden;}
			#container{height:100%;}
			#left{display: inline-block;height:100%;}
			#right{display: inline-block;height:100%;}
			#valueMarker{position:absolute;bottom:0px;width:1px;background-color: #f00;}
			#controls{position:absolute;right:20px;bottom:20px;padding:20px;background-color: #fff;border: 1pt solid #000;}
			.control{user-select: none;cursor:pointer;}
		</style>
	</head>
<body>

	<div id="container">
		<div id="left">
			<canvas id="cobweb"></canvas>
		</div>
		<div id="right">
			<canvas id="bifurcationDiagram"></canvas>
			<div id="controls">
				<div id="decrease" class="control">decrease</div>
				<div id="increase" class="control">increase</div>
				<div id="goleft" class="control">left</div>
				<div id="goright" class="control">right</div>
			</div>
		</div>
	</div>
	<div id="valueMarker"></div>
	
	<script>
		(function(){
			class ScaleWithValue{
				constructor(numberOfSteps){
					this._stepIndex = undefined;
					this.scaleStart = undefined;
					this.scaleEnd = undefined;
					this.numberOfSteps = numberOfSteps;
					this.steps = [];
				}
				get value(){
					return this.steps ? this.steps[this._stepIndex] : undefined;
				}
				setScale(start, end){
					this.scaleStart = start;
					this.scaleEnd = end;
					this.createSteps();
				}
				advanceStep(){
					this._stepIndex = Math.min(this.numberOfSteps - 1, this._stepIndex + 1);
				}
				retreatStep(){
					this._stepIndex = Math.max(0, this._stepIndex - 1);
				}
				moveScaleRight(){
					var stepSize = this.getStepSize();
					this.steps.splice(0, 1);
					this.scaleStart = this.steps[0];
					this.scaleEnd = this.scaleEnd + stepSize;
					this.steps.push(this.scaleEnd);
					console.log(JSON.stringify(this.steps))
				}
				moveScaleLeft(){
					var stepSize = this.getStepSize();
					this.steps.splice(this.numberOfSteps - 1, 1);
					this.scaleEnd = this.steps[this.numberOfSteps - 2];
					this.scaleStart -= stepSize;
					this.steps.unshift(this.scaleStart);
					console.log(JSON.stringify(this.steps))
				}
				getStepSize(){
					return (this.scaleEnd - this.scaleStart) / (this.numberOfSteps - 1);
				}
				createSteps(){
					this.steps = [];
					var stepSize = this.getStepSize();
					for(var i=0; i < this.numberOfSteps; i++){
						this.steps.push(this.scaleStart + i * stepSize);
					};
					if(this._stepIndex === undefined){
						this._stepIndex = Math.floor(this.numberOfSteps / 2);
					}
				}
			}

			var divideVertically = function(){
				var height = window.innerHeight;
				var cobwebCanvas = document.getElementById("cobweb");
				cobwebCanvas.style.height = height + "px";
				cobwebCanvas.style.width = height + "px";
				var bifurcationDiagramCanvas = document.getElementById("bifurcationDiagram");
				var bifurcationDiagramWidth = window.innerWidth - height - 10;
				bifurcationDiagramCanvas.style.width = bifurcationDiagramWidth + "px";
				bifurcationDiagramCanvas.style.height = height + "px";
			};

			divideVertically();

			var bifurcationDiagram;
			var controls;
			var cobweb;
			var scaleWithValue = new ScaleWithValue(30);
			var handleChange = function(){
				var newValue = scaleWithValue.value;
				if(newValue !== undefined){
					cobweb.drawWithValue(newValue);
					bifurcationDiagram.setMarkerAtValue(newValue);

				}
			};
			var setScale = function(start, end){
				scaleWithValue.setScale(start, end);
				handleChange();
			};
			var advanceStep = function(){
				scaleWithValue.advanceStep();
				handleChange();
			};
			var retreatStep = function(){
				scaleWithValue.retreatStep();
				handleChange();
			};
			var moveScaleRight = function(){
				scaleWithValue.moveScaleRight();
				bifurcationDiagram.setStartAndEnd(scaleWithValue.scaleStart, scaleWithValue.scaleEnd);
				handleChange();
			};
			var moveScaleLeft = function(){
				scaleWithValue.moveScaleLeft();
				bifurcationDiagram.setStartAndEnd(scaleWithValue.scaleStart, scaleWithValue.scaleEnd);
				handleChange();
			};

			cobweb = (function(){
				var canvas = document.getElementById("cobweb");
				var ctx = canvas.getContext("2d");
				var rect = canvas.getBoundingClientRect();
				var width = rect.width * devicePixelRatio, height = rect.height * devicePixelRatio;
				canvas.setAttribute("width", width);
				canvas.setAttribute("height", height);
				var drawWithValue = function(r){
					ctx.clearRect(0, 0, width, height);
					ctx.save();
					ctx.beginPath();
					ctx.moveTo(0, height);
					ctx.quadraticCurveTo(height / 2, height * (1 - r / 2), height, height);
					ctx.moveTo(0, height);
					ctx.lineTo(height, 0);
					ctx.stroke();

					var value = 0.5;
					var hue = 0;
					ctx.strokeStyle = "#00f";
					ctx.beginPath();
					var counter = 0;
					while(counter < 20000){
						ctx.strokeStyle = "hsla("+hue+",100%,50%,0.2)";
						ctx.beginPath();
						ctx.moveTo(value * height, (1 - value) * height);
						var newValue = r * value * (1 - value);
						ctx.lineTo(value * height, (1 - newValue) * height);
						ctx.lineTo(newValue * height, (1 - newValue) * height);
						ctx.stroke();
						value = newValue;
						hue += 0.03;
						counter++;
					}
					ctx.restore();
				};
				return {drawWithValue: drawWithValue};
			})();

			bifurcationDiagram = (function(scaleWithValue, setScale){
				var valueMarker = document.getElementById("valueMarker");
				var canvas = document.getElementById("bifurcationDiagram");
				var rect = canvas.getBoundingClientRect();
				valueMarker.style.height = rect.height + "px";
				var width = Math.ceil(rect.width * devicePixelRatio), height = Math.ceil(rect.height * devicePixelRatio);
				var canvasX = rect.x;
				canvas.setAttribute("width", width);
				canvas.setAttribute("height", height);
				var context = canvas.getContext("2d");
				var sliceWidth = 10;
				var currentCancellationToken = undefined;
				var coordsMinX = 0;
				var coordsMaxX = 4;
				var coordsMinY = 0;
				var coordsMaxY = 1;
				var processor = new ParallelProcessor(10, "(" + (function(){
					var sliceWidth, coordsMinX, coordsMinY, coordsMaxX, coordsMaxY, width, height;
					var pointWidth;
					var getCoordsX = function(x){
						return coordsMinX + (coordsMaxX - coordsMinX) * x / width;
					};
					var getRealY = function(y){
						return Math.floor(height * (coordsMaxY - y) / (coordsMaxY - coordsMinY));
					};
					var getArrayIndexForPoint = function(x, y){
						return 4 * sliceWidth * y + 4 * x;
					};
					var colorPoint = function(x, y, array){
						if(x >= 0 && x < sliceWidth && y >= 0 && y < height){
							var index = getArrayIndexForPoint(x, y);
							array[index + 3] += pointWidth;
						}
					};
					var displayValue = function(value, x, array){
						var realY = getRealY(value);
						colorPoint(x, realY, array);
					};
					var drawPointsForX = function(sliceStart, x, array){
						var coordsX = getCoordsX(sliceStart + x);
						var value = 0.1;
						var counter = 0;
						while(counter < 40000){
							if(counter > 5000){
								displayValue(value, x, array);
							}
							value = coordsX * value * (1 - value);
							counter++;
						}
					};
					process = function(req){
						var array = new Uint8ClampedArray(4 * sliceWidth * height);
						for(var x = 0; x < sliceWidth; x++){
							drawPointsForX(req.x, x, array);
						}
						return array.buffer;
					};
					update = function(_sliceWidth, _coordsMinX, _coordsMinY, _coordsMaxX, _coordsMaxY, _width, _height){
						sliceWidth = _sliceWidth;
						coordsMinX = _coordsMinX;
						coordsMinY = _coordsMinY;
						coordsMaxX = _coordsMaxX;
						coordsMaxY = _coordsMaxY;
						width = _width;
						height = _height;
						pointWidth = 5 + 250 * (1 / (1 + Math.pow(60 * (coordsMaxY - coordsMinY), 2)));
					};		
				}).toString() + ")()");

				var drawSlice = async function(x, cancellationToken){
					var buffer = await processor.process({x: x}, cancellationToken);
					var array = new Uint8ClampedArray(buffer);
					var imageData = new ImageData(array, sliceWidth);
					context.putImageData(imageData, x, 0);
				};

				var setMarkerAtValue = function(value){
					var relativeValue = (value - coordsMinX) / (coordsMaxX - coordsMinX);
					valueMarker.style.left = (rect.x + rect.width * relativeValue) + "px";
				};

				var drawAll = async function(){
					if(currentCancellationToken){
						currentCancellationToken.cancel();
					}
					context.clearRect(0, 0, width, height);
					setScale(coordsMinX, coordsMaxX);
					await processor.update(sliceWidth, coordsMinX, coordsMinY, coordsMaxX, coordsMaxY, width, height);
					currentCancellationToken = processor.getCancellationToken();
					var numberOfSlices = Math.ceil(width / sliceWidth);
					for(var i=0;i<numberOfSlices;i++){
						drawSlice(i * sliceWidth, currentCancellationToken);
					}
				};

				var setStartAndEnd = function(start, end){
					coordsMinX = start;
					coordsMaxX = end;
					drawAll();
				};

				setTimeout(drawAll, 0);

				var borderWidth = Math.min(width / 6, height / 6);
				canvas.addEventListener("contextmenu", function(e){
					var realX = (e.clientX - canvasX) * devicePixelRatio;
					var realY = e.clientY * devicePixelRatio;
					var currentValue = scaleWithValue.value;
					coordsMinX = currentValue - (currentValue - coordsMinX) * 2;
					coordsMaxX = currentValue + (coordsMaxX - currentValue) * 2;
					drawAll();
					e.preventDefault();
					return false;
				});
				canvas.addEventListener("click", function(e){
					var realX = (e.clientX - canvasX) * devicePixelRatio;
					var realY = e.clientY * devicePixelRatio;
					var currentValue = scaleWithValue.value;
					coordsMinX = currentValue - (currentValue - coordsMinX) / 2;
					coordsMaxX = currentValue + (coordsMaxX - currentValue) / 2;
					drawAll();
				});

				return {
					setMarkerAtValue: setMarkerAtValue,
					setStartAndEnd: setStartAndEnd
				};
			})(scaleWithValue, setScale);

			controls = (function(bifurcationDiagram){
				document.getElementById("decrease").addEventListener("click", function(){
					retreatStep();
				});
				document.getElementById("increase").addEventListener("click", function(){
					advanceStep();
				});
				document.getElementById("goleft").addEventListener("click", function(){
					moveScaleLeft();
				});
				document.getElementById("goright").addEventListener("click", function(){
					moveScaleRight();
				});
			})(bifurcationDiagram);
		})();
	</script>
</body>
</html>